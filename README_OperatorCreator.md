# ğŸ­ Criador de Operadores Completos - Sistema Mould

Sistema completo para criaÃ§Ã£o de operadores no sistema de moldagem com integraÃ§Ã£o total ao Supabase, incluindo criaÃ§Ã£o de usuÃ¡rios, registros nas tabelas relacionadas e criptografia compatÃ­vel com TypeScript.

## ğŸ¯ O que o Sistema Faz

O sistema automatiza completamente a criaÃ§Ã£o de novos operadores, incluindo:

1. **CriaÃ§Ã£o de usuÃ¡rio no Supabase Auth** (`auth.users`)
2. **Registro na tabela `public.users`** (necessÃ¡rio para RLS)
3. **Registro na tabela `operador`** com dados pessoais e configuraÃ§Ãµes
4. **CriaÃ§Ã£o de acesso rÃ¡pido** na tabela `operator_fast_acess` com PIN e criptografia
5. **ValidaÃ§Ã£o completa** do sistema criado
6. **ExportaÃ§Ã£o de dados** para backup e documentaÃ§Ã£o

## ğŸ“‹ PrÃ©-requisitos

```bash
pip install cryptography pyperclip requests tkinter
```

> **Nota:** `tkinter` geralmente jÃ¡ vem incluÃ­do no Python padrÃ£o.

## ğŸš€ Como Usar

### 1. Executar a Interface

```bash
python operator_creator.py
```

Ou use o instalador automÃ¡tico:

```bash
python setup.py
```

### 2. Preencher os Dados do Operador

- **Nome Completo**: Nome completo do operador
- **Email**: Email vÃ¡lido para login no Supabase Auth
- **PIN**: 4 dÃ­gitos Ãºnicos para acesso rÃ¡pido
- **Cargo**: FunÃ§Ã£o/cargo do operador na empresa

### 3. ConfiguraÃ§Ãµes AutomÃ¡ticas

O sistema aplica automaticamente:
- **Senha padrÃ£o**: `indus1234` (pode ser alterada depois)
- **Empresa ID**: `5` (configurÃ¡vel no cÃ³digo)
- **Criptografia**: AES-256-CBC compatÃ­vel com TypeScript
- **Email confirmado**: UsuÃ¡rio jÃ¡ ativo no sistema

### 4. Criar Operador

1. Clique em **"ğŸ­ Criar Operador Completo"**
2. O sistema executarÃ¡ automaticamente:
   - âœ… GeraÃ§Ã£o de credenciais criptografadas
   - âœ… CriaÃ§Ã£o de usuÃ¡rio no Supabase Auth
   - âœ… Registro na tabela operador
   - âœ… CriaÃ§Ã£o de acesso rÃ¡pido (PIN)

### 5. Verificar Sistema

1. Clique em **"ğŸ” Testar Sistema"**
2. Executa verificaÃ§Ãµes completas:
   - UsuÃ¡rio existe no Supabase Auth
   - Registro operador foi criado
   - Acesso rÃ¡pido estÃ¡ funcionando
   - Descriptografia estÃ¡ operacional

### 6. Exportar Dados

- **ğŸ“‹ Copiar Credenciais**: Copia dados para Ã¡rea de transferÃªncia
- **ğŸ’¾ Exportar Dados**: Salva JSON com todos os dados criados

## ğŸ—ï¸ Estrutura das Tabelas

### 1. Tabela: `auth.users` (Supabase Auth)

Criada automaticamente via API administrativa do Supabase:

```json
{
  "id": "uuid-gerado",
  "email": "operador@empresa.com",
  "email_confirmed_at": "timestamp-atual",
  "password": "hash-da-senha"
}
```

### 2. Tabela: `public.users`

Registro necessÃ¡rio para funcionamento das regras RLS (Row Level Security):

```sql
CREATE TABLE public.users (
  id uuid NOT NULL,
  first_name text NULL,
  last_name text NULL,
  id_empresa bigint NULL,
  email text NULL,
  "Nivel" smallint NULL DEFAULT '2'::smallint,
  CONSTRAINT profiles_pkey PRIMARY KEY (id),
  CONSTRAINT profiles_email_key UNIQUE (email),
  CONSTRAINT profiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users (id) ON DELETE CASCADE,
  CONSTRAINT users_id_empresa_fkey FOREIGN KEY (id_empresa) REFERENCES empresa (id)
);
```

### 3. Tabela: `operador`

```sql
CREATE TABLE public.operador (
  id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  nome text NULL,
  empresa bigint NULL,
  equipamento_atual bigint NULL,
  cargo text NULL,
  jornada_atual bigint NULL,
  "Delete" boolean NULL DEFAULT false,
  foto text NULL,
  em_trabalho boolean NULL DEFAULT false,
  "user" uuid NULL,
  dashboard_view_style character varying(20) NULL DEFAULT 'grid'::character varying,
  CONSTRAINT operador_pkey PRIMARY KEY (id),
  CONSTRAINT operador_empresa_fkey FOREIGN KEY (empresa) REFERENCES empresa (id),
  CONSTRAINT operador_user_fkey FOREIGN KEY ("user") REFERENCES users (id)
);
```

### 4. Tabela: `operator_fast_acess`

```sql
CREATE TABLE public.operator_fast_acess (
  "PIN" integer GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  encrypted_acess text NULL,
  "user" uuid NOT NULL,
  operador bigint NULL,
  CONSTRAINT operator_fast_acess_pkey PRIMARY KEY ("PIN", "user"),
  CONSTRAINT operator_fast_acess_user_key UNIQUE ("user"),
  CONSTRAINT operator_fast_acess_operador_fkey FOREIGN KEY (operador) REFERENCES operador (id),
  CONSTRAINT operator_fast_acess_user_fkey FOREIGN KEY ("user") REFERENCES users (id)
);
```

## ğŸ”§ ConfiguraÃ§Ãµes do Sistema

### Service Role Key

O sistema usa a service role key do Supabase para criaÃ§Ãµes administrativas:

```python
SUPABASE_SERVICE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

### ConfiguraÃ§Ãµes PadrÃ£o

```python
DEFAULT_PASSWORD = "indus1234"     # Senha padrÃ£o para todos
DEFAULT_EMPRESA_ID = 5             # ID da empresa atual
SUPABASE_URL = "https://oixnkjcvkfdimwoikzgl.supabase.co"
```

## ğŸ” Como Funciona a Criptografia

### 1. PreparaÃ§Ã£o das Credenciais
```python
credentials = {
    "email": "operador@empresa.com", 
    "password": "indus1234"
}
```

### 2. GeraÃ§Ã£o da Chave
```python
key = SHA256(pin).hexdigest()  # PIN -> SHA256 -> Hex
```

### 3. Criptografia AES-256-CBC
```python
iv = random_bytes(16)              # IV aleatÃ³rio
encrypted = AES256_CBC(data, key, iv)
```

### 4. Estrutura Final
```json
{
  "iv": "base64_encoded_iv",
  "content": "base64_encoded_content"
}
```

## ğŸ“Š Exemplo de Uso Completo

### Entrada:
```
Nome: JoÃ£o Silva Santos
Email: joao.silva@empresa.com
PIN: 1234
Cargo: Operador de MÃ¡quinas
```

### Processo Executado:
1. **Credenciais criptografadas geradas** âœ…
2. **UsuÃ¡rio criado no Supabase Auth** âœ…
   - ID: `550e8400-e29b-41d4-a716-446655440000`
3. **Registro public.users criado** âœ…
   - ID: `550e8400-e29b-41d4-a716-446655440000`
   - Email e empresa vinculados
4. **Operador registrado** âœ…
   - ID: `15`
   - Empresa: `5`
   - UsuÃ¡rio vinculado
5. **Acesso rÃ¡pido criado** âœ…
   - PIN: `1234`
   - Criptografia AES-256-CBC

### Resultado:
```json
{
  "nome": "JoÃ£o Silva Santos",
  "email": "joao.silva@empresa.com",
  "cargo": "Operador de MÃ¡quinas",
  "pin": 1234,
  "password": "indus1234",
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "operador_id": 15,
  "empresa_id": 5
}
```

## ğŸ” Log de ExecuÃ§Ã£o

O sistema exibe logs detalhados de todo o processo:

```
[14:30:15] ğŸš€ Iniciando criaÃ§Ã£o de operador completo...
[14:30:16] ğŸ” Gerando credenciais criptografadas...
[14:30:16] âœ… Credenciais criptografadas geradas com sucesso
[14:30:17] ğŸ‘¤ Criando usuÃ¡rio no Supabase Auth...
[14:30:18] âœ… UsuÃ¡rio criado com ID: 550e8400-e29b-41d4-a716-446655440000
[14:30:19] ğŸ‘¤ Criando registro na tabela public.users...
[14:30:20] âœ… Registro public.users criado com ID: 550e8400-e29b-41d4-a716-446655440000
[14:30:21] ğŸ“ Criando registro na tabela operador...
[14:30:22] âœ… Operador criado com ID: 15
[14:30:23] ğŸ”‘ Criando acesso rÃ¡pido (PIN)...
[14:30:24] âœ… Acesso rÃ¡pido criado com PIN: 1234
[14:30:24] ğŸ‰ OPERADOR CRIADO COM SUCESSO!
```

## ğŸ› ï¸ Troubleshooting

### Erro: MÃ³dulo nÃ£o encontrado
```bash
pip install cryptography pyperclip requests
```

### Erro: Email jÃ¡ existe
- O Supabase nÃ£o permite emails duplicados
- Use email diferente ou delete o usuÃ¡rio existente

### Erro: PIN jÃ¡ existe
- PINs devem ser Ãºnicos
- Use PIN diferente ou verifique tabela operator_fast_acess

### Erro: Service Role Key invÃ¡lida
- Verifique se a key estÃ¡ correta
- Confirme permissÃµes administrativas

### Erro: Duplicate key value violates unique constraint 'profiles_pkey'
- **Problema:** UsuÃ¡rio jÃ¡ existe na tabela `public.users`
- **SoluÃ§Ã£o:** Sistema agora usa UPSERT (INSERT ou UPDATE)
- **Resultado:** Registro Ã© criado ou atualizado automaticamente
- **AÃ§Ã£o:** Nenhuma aÃ§Ã£o necessÃ¡ria, sistema resolve automaticamente

### Erro: Empresa ID nÃ£o existe
- Verifique se empresa ID=5 existe na tabela empresa
- Ajuste DEFAULT_EMPRESA_ID no cÃ³digo se necessÃ¡rio

## ğŸ”— IntegraÃ§Ã£o com Sistema Existente

### No Frontend TypeScript

O operador criado jÃ¡ pode fazer login imediatamente:

1. **Digite o PIN** na interface (ex: 1234)
2. **Sistema descriptografa** automaticamente as credenciais
3. **Login automÃ¡tico** no Supabase Auth
4. **Acesso completo** ao sistema

### Compatibilidade

- âœ… **Criptografia idÃªntica** ao sistema TypeScript
- âœ… **Estrutura de dados compatÃ­vel**
- âœ… **Processo de login inalterado**
- âœ… **Sem modificaÃ§Ãµes necessÃ¡rias** no frontend

## ğŸ“ˆ Funcionalidades AvanÃ§adas

### ValidaÃ§Ã£o AutomÃ¡tica
- Campos obrigatÃ³rios verificados
- Formato de email validado
- PIN com exatamente 4 dÃ­gitos
- Dados consistentes entre tabelas

### Testes Integrados
- VerificaÃ§Ã£o completa do usuÃ¡rio criado
- ValidaÃ§Ã£o de relacionamentos FK
- Teste de descriptografia
- ConfirmaÃ§Ã£o de funcionamento

### Backup e ExportaÃ§Ã£o
- Credenciais copiÃ¡veis
- Dados exportados em JSON
- Logs completos de execuÃ§Ã£o
- HistÃ³rico para auditoria

## ğŸ”’ SeguranÃ§a

### âš ï¸ Importante:
- **Service role key** tem permissÃµes administrativas completas
- **Guarde credenciais** em local seguro
- **Senhas padrÃ£o** devem ser alteradas pelos operadores
- **PINs Ãºnicos** por operador sÃ£o obrigatÃ³rios

### ğŸ›¡ï¸ Boas PrÃ¡ticas:
- Use emails corporativos vÃ¡lidos
- Documente todos os operadores criados
- Mantenha backup das credenciais
- Monitore acessos ao sistema
- Atualize senhas regularmente

---

## ğŸ“ Suporte

Em caso de problemas:
1. Verifique os logs detalhados no sistema
2. Confirme configuraÃ§Ãµes do Supabase
3. Valide estruturas das tabelas
4. Teste com dados simples primeiro
5. Verifique permissÃµes da service role key 